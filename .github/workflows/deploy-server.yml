name: Deploy Server
on: [workflow_dispatch]
env:
  FOLDER_NAME: scaled-frames
jobs:
  deploy-server:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
      
      - name: Add Known Hosts
        # removing the `user@` from the ec2_host
        run: |
          ssh-keyscan -H "$(echo ${{ secrets.EC2_HOST }} | awk -F@ '{print $2}')" >> ~/.ssh/known_hosts
      
      - name: Check out repository code
        uses: actions/checkout@v4
        with:
          path: ${{ env.FOLDER_NAME }}

      # Going into folder, creating an .env
      - name: Create .env file
        run: |
          cd ${{ env.FOLDER_NAME }}
          echo "DATABASE_URL=${{ secrets.DATABASE_URL }}" >> .env
          echo "DIRECT_DB_URL=${{ secrets.DIRECT_DB_URL }}" >> .env
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> .env
          echo "SUPABASE_JWT_SECRET=${{ secrets.SUPABASE_JWT_SECRET }}" >> .env
          echo "NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}" >> .env
          echo "NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}" >> .env
          echo "NEXT_PUBLIC_CLIENT_URL=${{ secrets.NEXT_PUBLIC_CLIENT_URL }}" >> .env
          echo "NEXT_PUBLIC_API_FRAMER_URL=${{ secrets.NEXT_PUBLIC_API_FRAMER_URL }}" >> .env
          echo "NEXT_PUBLIC_API_FRAMER_PORT=${{ secrets.NEXT_PUBLIC_API_FRAMER_PORT }}" >> .env

      - name: Transfer Repository to EC2
        # Copying over only what has changed
        run: |
          cd ${{ env.FOLDER_NAME }}
          rsync -avz --exclude 'node_modules' --exclude '.git' --exclude 'apps/framer' --exclude 'apps/framer-e2e' \
            -e "ssh -i ~/.ssh/aws-west-mbp.pem" \
            . ${{ secrets.EC2_HOST }}:~/framer
      
      - name: Update install
        run: | 
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_HOST }} << 'EOF'
            npm install
            cd framer/libs/framer-db/
            npx prisma generate
          EOF
      
      - name: Restart EC2 Services
        run: |
          ssh -i ~/.ssh/id_rsa ${{ secrets.EC2_host }} << 'EOF'
            sudo systemctl restart myapp.service
            sudo systemctl restart caddy
          EOF